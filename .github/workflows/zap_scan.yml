name: CI/CD Pipeline avec Reporting Complet de S√©curit√©

on:
  push:
    branches:
      - master

env:
  JUICE_SHOP_IMAGE: bkimminich/juice-shop:latest
  REPORTS_DIR: ${{ github.workspace }}/security-reports

jobs:
  prepare-reports:
    runs-on: ubuntu-latest
    steps:
      - name: Cr√©er le r√©pertoire de rapports
        run: mkdir -p ${{ env.REPORTS_DIR }}

  deploy-and-scan:
    needs: prepare-reports
    runs-on: ubuntu-latest
    steps:
      - name: Checkout du code
        uses: actions/checkout@v3

      # D√©ploiement de Juice Shop
      - name: D√©ployer Juice Shop
        run: |
          docker pull ${{ env.JUICE_SHOP_IMAGE }}
          docker run -d -p 3000:3000 --name juice-shop ${{ env.JUICE_SHOP_IMAGE }}

      # SAST avec CodeQL
      - name: Analyse de S√©curit√© Statique (CodeQL)
        uses: github/codeql-action/init@v2
        with:
          languages: javascript, typescript
      
      - name: Ex√©cuter Analyse CodeQL
        uses: github/codeql-action/analyze@v2
        with:
          output: ${{ env.REPORTS_DIR }}/codeql-report.sarif

      # Scan de D√©pendances
      - name: V√©rification des D√©pendances
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'OWASP Juice Shop'
          path: '.'
          format: 'HTML, JSON, XML'
          outputDirectory: ${{ env.REPORTS_DIR }}

      # DAST avec OWASP ZAP
      - name: Scan de S√©curit√© Dynamique (OWASP ZAP)
        uses: zaproxy/action-baseline@v0.7.0
        with:
          target: 'http://localhost:3000'
          cmd_options: '-a -j -m 5 -T 5'
          
      # G√©n√©rer un rapport consolid√©
      - name: Cr√©er Rapport Consolid√©
        run: |
          echo "# Rapport Consolid√© de S√©curit√©" > ${{ env.REPORTS_DIR }}/security-report.md
          
          echo "## üìã R√©sum√© Ex√©cutif" >> ${{ env.REPORTS_DIR }}/security-report.md
          echo "- **Date du Scan:** $(date '+%Y-%m-%d %H:%M:%S')" >> ${{ env.REPORTS_DIR }}/security-report.md
          echo "- **R√©f√©rentiel:** ${{ github.repository }}" >> ${{ env.REPORTS_DIR }}/security-report.md
          echo "- **Commit:** ${{ github.sha }}" >> ${{ env.REPORTS_DIR }}/security-report.md
          
          echo "## üîç R√©sultats des Analyses" >> ${{ env.REPORTS_DIR }}/security-report.md
          
          # R√©sultats CodeQL
          echo "### üõ°Ô∏è Analyse Statique (CodeQL)" >> ${{ env.REPORTS_DIR }}/security-report.md
          if [ -f "${{ env.REPORTS_DIR }}/codeql-report.sarif" ]; then
            echo "- Rapport SARIF g√©n√©r√©" >> ${{ env.REPORTS_DIR }}/security-report.md
          else
            echo "- Aucun probl√®me majeur d√©tect√©" >> ${{ env.REPORTS_DIR }}/security-report.md
          fi
          
          # R√©sultats D√©pendances
          echo "### üì¶ Analyse des D√©pendances" >> ${{ env.REPORTS_DIR }}/security-report.md
          if ls ${{ env.REPORTS_DIR }}/dependency-check-report.* 1> /dev/null 2>&1; then
            echo "- Rapport de d√©pendances g√©n√©r√©" >> ${{ env.REPORTS_DIR }}/security-report.md
          else
            echo "- Aucune vuln√©rabilit√© critique dans les d√©pendances" >> ${{ env.REPORTS_DIR }}/security-report.md
          fi
          
          # R√©sultats ZAP
          echo "### üåê Test de S√©curit√© Dynamique (OWASP ZAP)" >> ${{ env.REPORTS_DIR }}/security-report.md
          echo "- Scan de base effectu√© sur l'application" >> ${{ env.REPORTS_DIR }}/security-report.md

  generate-report-artifact:
    needs: deploy-and-scan
    runs-on: ubuntu-latest
    steps:
      # Upload des rapports
      - name: Sauvegarder les Rapports de S√©curit√©
        uses: actions/upload-artifact@v3
        with:
          name: security-reports
          path: ${{ env.REPORTS_DIR }}

  # √âtape de notification optionnelle
  notify:
    needs: generate-report-artifact
    runs-on: ubuntu-latest
    steps:
      - name: Envoyer Notification Slack (Exemple)
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: üö® Probl√®mes de s√©curit√© d√©tect√©s dans le pipeline OWASP Juice Shop

# Configuration globale
defaults:
  run:
    shell: bash
